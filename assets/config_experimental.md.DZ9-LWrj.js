import{_ as p,b as h,o as r,i as o,j as a,S as i,g as n,w as t,R as l,aH as k,aI as d}from"./chunks/framework.XDTXXE-5.js";const w=JSON.parse('{"title":"实验性 | Config","description":"","frontmatter":{"title":"实验性 | Config","outline":"deep"},"headers":[],"relativePath":"config/experimental.md","filePath":"config/experimental.md","lastUpdated":1771601921000}'),c={name:"config/experimental.md"},g={id:"experimental-fsmodulecache",tabindex:"-1"},E={id:"experimental-fsmodulecachepath",tabindex:"-1"},y={id:"experimental-opentelemetry",tabindex:"-1"},u={id:"experimental-importdurations",tabindex:"-1"},m={id:"experimental-vitemodulerunner",tabindex:"-1"},f={id:"experimental-nodeloader",tabindex:"-1"};function F(b,s,v,D,A,C){const e=h("Version");return r(),o("div",null,[s[24]||(s[24]=a("h1",{id:"experimental",tabindex:"-1"},[i("experimental "),a("a",{class:"header-anchor",href:"#experimental","aria-label":"Permalink to “experimental”"},"​")],-1)),a("h2",g,[s[1]||(s[1]=i("experimental.fsModuleCache ",-1)),n(e,{type:"experimental"},{default:t(()=>[...s[0]||(s[0]=[i("4.0.11",-1)])]),_:1}),s[2]||(s[2]=i()),s[3]||(s[3]=a("a",{class:"header-anchor",href:"#experimental-fsmodulecache","aria-label":"Permalink to “experimental.fsModuleCache 4.0.11”"},"​",-1))]),s[25]||(s[25]=l(`<div class="tip custom-block"><p class="custom-block-title">功能反馈</p><p>请将关于此功能反馈提交至 <a href="https://github.com/vitest-dev/vitest/discussions/9221" target="_blank" rel="noreferrer">GitHub Discussion</a>。</p></div><ul><li><strong>类型:</strong> <code>boolean</code></li><li><strong>默认值:</strong> <code>false</code></li></ul><p>启用此选项后， Vitest 会将缓存的模块保存在文件系统上，从而在重新运行测试时获得更快的执行速度。</p><p>你可以通过运行 <a href="/guide/cli.html#clearcache"><code>vitest --clearCache</code></a> 来删除旧缓存。</p><div class="warning custom-block"><p class="custom-block-title">浏览器支持</p><p>目前，此选项不会影响 <a href="/guide/browser/">浏览器模式</a>。</p></div><p>在运行 vitest 你可以设置 <code>DEBUG=vitest:cache:fs</code> 环境变量，来调试模块是否被缓存：</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DEBUG</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">vitest:cache:fs</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vitest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --experimental.fsModuleCache</span></span></code></pre></div><h3 id="known-issues" tabindex="-1">已知问题 <a class="header-anchor" href="#known-issues" aria-label="Permalink to “已知问题”">​</a></h3><p>Vitest 基于文件内容、文件 id、vite 的环境配置及覆盖率状态生成持久性文件哈希值。虽然 Vitest 会尽可能利用所有可获取的配置信息，但目前仍存在局限性。由于缺乏标准接口支持，当前无法追踪插件选项的变更情况。</p><p>如果你的插件依赖文件内容或公开配置之外的因素（例如读取其他文件或目录），则可能出现缓存失效的情况。要解决这个问题，你可以定义一个 <a href="/api/advanced/plugin.html#definecachekeygenerator">缓存键生成器</a> 来指定动态选项，或选择对该模块禁用缓存：</p><div class="vp-code-block-title"><div class="vp-code-block-title-bar"><span class="vp-code-block-title-text" data-title="vitest.config.js">vitest.config.js</span></div><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vitest/config&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;vitest-cache&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      configureVitest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">experimental_defineCacheKeyGenerator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        experimental_defineCacheKeyGenerator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sourceCode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 从不缓存此 id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (id.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;do-not-cache&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // 根据动态变量的值缓存该文件</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">          if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (sourceCode.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;myDynamicVar&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> process.env.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">DYNAMIC_VAR_VALUE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  test: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    experimental: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fsModuleCache: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div></div><p>如果你是插件作者，当你的插件可以通过不同配置选项影响转换结果时，建议在插件中定义 <a href="/api/advanced/plugin.html#definecachekeygenerator">缓存键生成器</a>。</p><p>另一方面，如果你的插件不应该影响缓存键，你可以通过将 <code>api.vitest.experimental.ignoreFsModuleCache</code> 设置为 <code>true</code> 来退出缓存机制：</p><div class="vp-code-block-title"><div class="vp-code-block-title-bar"><span class="vp-code-block-title-text" data-title="vitest.config.js">vitest.config.js</span></div><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vitest/config&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;vitest-cache&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      api: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        vitest: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          experimental: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ignoreFsModuleCache: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  test: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    experimental: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fsModuleCache: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div></div><p>请注意，即使插件选择禁用缓存模块，你仍然可以定义缓存键生成器。</p>`,15)),a("h2",E,[s[5]||(s[5]=i("experimental.fsModuleCachePath ",-1)),n(e,{type:"experimental"},{default:t(()=>[...s[4]||(s[4]=[i("4.0.11",-1)])]),_:1}),s[6]||(s[6]=i()),s[7]||(s[7]=a("a",{class:"header-anchor",href:"#experimental-fsmodulecachepath","aria-label":"Permalink to “experimental.fsModuleCachePath 4.0.11”"},"​",-1))]),s[26]||(s[26]=l('<ul><li><strong>类型:</strong> <code>string</code></li><li><strong>默认值:</strong> <code>&#39;node_modules/.experimental-vitest-cache&#39;</code></li></ul><p>文件系统缓存所在的目录。</p><p>默认情况下，Vitest 会尝试查找工作区根目录，并将缓存存储在 <code>node_modules</code> 文件夹中。根目录的确定基于你所使用的包管理器的锁文件（例如，<code>.package-lock.json</code>、<code>.yarn-state.yml</code>、<code>.pnpm/lock.yaml</code> 等）。</p><p>目前，Vitest 会完全忽略 <a href="/config/cache.html">test.cache.dir</a> 或 <a href="https://vite.dev/config/shared-options#cachedir" target="_blank" rel="noreferrer">cacheDir</a> 配置选项，并创建一个单独的缓存文件夹。</p>',4)),a("h2",y,[s[9]||(s[9]=i("experimental.openTelemetry ",-1)),n(e,{type:"experimental"},{default:t(()=>[...s[8]||(s[8]=[i("4.0.11",-1)])]),_:1}),s[10]||(s[10]=i()),s[11]||(s[11]=a("a",{class:"header-anchor",href:"#experimental-opentelemetry","aria-label":"Permalink to “experimental.openTelemetry 4.0.11”"},"​",-1))]),s[27]||(s[27]=l(`<div class="tip custom-block"><p class="custom-block-title">功能反馈</p><p>请将关于此功能反馈提交至 <a href="https://github.com/vitest-dev/vitest/discussions/9222" target="_blank" rel="noreferrer">GitHub Discussion</a>。</p></div><ul><li><strong>类型:</strong></li></ul><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OpenTelemetryOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  enabled</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * 暴露 Node.js OpenTelemetry SDK 的文件路径</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  sdkPath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * 暴露浏览器 OpenTelemetry SDK 的文件路径</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  browserSdkPath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>默认值:</strong> <code>{ enabled: false }</code></li></ul><p>此选项控制 <a href="https://opentelemetry.io/" target="_blank" rel="noreferrer">OpenTelemetry</a> 支持。当 <code>enabled</code> 设置为 <code>true</code>，Vitest 会在主线程中以及每个测试文件之前导入 SDK 文件。</p><div class="danger custom-block"><p class="custom-block-title">性能警告</p><p>OpenTelemetry 可能会显著影响 Vitest 性能；建议仅在本地调试时启用它。</p></div><p>你可以将 <a href="/guide/open-telemetry.html">自定义服务</a> 与 Vitest 一起使用，以精确定位正在拖慢测试套件执行速度的测试或文件。</p><p>对于浏览器模式，请参阅 OpenTelemetry 指南的 <a href="/guide/open-telemetry.html#browser-mode">浏览器模式</a> 部分。</p><p><code>sdkPath</code> 的路径解析相对于项目的 <a href="/config/root.html"><code>root</code></a> 解析，应指向一个默认导出已初始化 SDK 实例的模块。例如：</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-122" id="tab-123" checked><label data-title="otel.js" for="tab-123">otel.js</label><input type="radio" name="group-122" id="tab-124"><label data-title="vitest.config.js" for="tab-124">vitest.config.js</label></div><div class="blocks"><div class="language-js active"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { getNodeAutoInstrumentations } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@opentelemetry/auto-instrumentations-node&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { OTLPTraceExporter } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@opentelemetry/exporter-trace-otlp-proto&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { NodeSDK } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@opentelemetry/sdk-node&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sdk</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NodeSDK</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  serviceName: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;vitest&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  traceExporter: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OTLPTraceExporter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  instrumentations: [</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getNodeAutoInstrumentations</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sdk.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sdk</span></span></code></pre></div><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vitest/config&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  test: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    experimental: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      openTelemetry: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        enabled: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        sdkPath: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./otel.js&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div></div></div><div class="warning custom-block"><p class="custom-block-title custom-block-title-default">WARNING</p><p>请注意 Node 必须能够直接处理 <code>sdkPath</code> 指向的内容，因为它不会被 Vitest 转换。了解如何在 Vitest 中使用 OpenTelemetry ，详情参阅 <a href="/guide/open-telemetry.html">指南</a>。</p></div>`,11)),a("h2",u,[s[13]||(s[13]=i("experimental.importDurations ",-1)),n(e,{type:"experimental"},{default:t(()=>[...s[12]||(s[12]=[i("4.1.0",-1)])]),_:1}),s[14]||(s[14]=i()),s[15]||(s[15]=a("a",{class:"header-anchor",href:"#experimental-importdurations","aria-label":"Permalink to “experimental.importDurations 4.1.0”"},"​",-1))]),s[28]||(s[28]=l(`<div class="tip custom-block"><p class="custom-block-title">功能反馈</p><p>请将关于此功能反馈提交至 <a href="https://github.com/vitest-dev/vitest/discussions/9224" target="_blank" rel="noreferrer">GitHub Discussion</a>。</p></div><ul><li><strong>Type:</strong></li></ul><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ImportDurationsOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * When to print import breakdown to CLI terminal.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * - false: Never print (default)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * - true: Always print</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * - &#39;on-warn&#39;: Print only when any import exceeds warn threshold</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  print</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;on-warn&#39;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * Fail the test run if any import exceeds the danger threshold.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * When enabled and threshold exceeded, breakdown is always printed.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> false</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  failOnDanger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * Maximum number of imports to collect and display.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  limit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * Duration thresholds in milliseconds for coloring and warnings.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">  thresholds</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /** Threshold for yellow/warning color. </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 100</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    warn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /** Threshold for red/danger color and failOnDanger. </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 500</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">    danger</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>Default:</strong> <code>{ print: false, failOnDanger: false, limit: 0, thresholds: { warn: 100, danger: 500 } }</code> (<code>limit</code> is 10 if <code>print</code> or UI is enabled)</li></ul><p>Configure import duration collection and display.</p><p>The <code>print</code> option controls CLI terminal output. The <code>limit</code> option controls how many imports to collect and display. <a href="/guide/ui.html#import-breakdown">Vitest UI</a> can always toggle the breakdown display regardless of the <code>print</code> setting.</p><ul><li>Self：模块导入耗时，不包括静态导入；</li><li>Total：模块导入耗时，包括静态导入。请注意，这不包括当前模块的 <code>transform</code> 时间。</li></ul><img alt="终端中导入耗时明细的示例" src="`+k+'"><img alt="终端中导入耗时明细的示例" src="'+d+'"><p>请注意，如果文件路径太长，Vitest 会从开头截断它，最多显示 45 个字符。</p><h3 id="experimental-importdurationsprint" tabindex="-1">experimental.importDurations.print <a class="header-anchor" href="#experimental-importdurationsprint" aria-label="Permalink to “experimental.importDurations.print”">​</a></h3><ul><li><strong>Type:</strong> <code>boolean | &#39;on-warn&#39;</code></li><li><strong>Default:</strong> <code>false</code></li></ul><p>Controls when to print import breakdown to CLI terminal after tests finish. This only works with <a href="/guide/reporters.html#default"><code>default</code></a>, <a href="/guide/reporters.html#verbose"><code>verbose</code></a>, or <a href="/guide/reporters.html#tree"><code>tree</code></a> reporters.</p><ul><li><code>false</code>: Never print breakdown</li><li><code>true</code>: Always print breakdown</li><li><code>&#39;on-warn&#39;</code>: Print only when any import exceeds the <code>thresholds.warn</code> value</li></ul><h3 id="experimental-importdurationsfailondanger" tabindex="-1">experimental.importDurations.failOnDanger <a class="header-anchor" href="#experimental-importdurationsfailondanger" aria-label="Permalink to “experimental.importDurations.failOnDanger”">​</a></h3><ul><li><strong>Type:</strong> <code>boolean</code></li><li><strong>Default:</strong> <code>false</code></li></ul><p>Fail the test run if any import exceeds the <code>thresholds.danger</code> value. When enabled and the threshold is exceeded, the breakdown is always printed regardless of the <code>print</code> setting.</p><p>This is useful for enforcing import performance budgets in CI:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vitest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --experimental.importDurations.failOnDanger</span></span></code></pre></div><h3 id="experimental-importdurationslimit" tabindex="-1">experimental.importDurations.limit <a class="header-anchor" href="#experimental-importdurationslimit" aria-label="Permalink to “experimental.importDurations.limit”">​</a></h3><ul><li><strong>Type:</strong> <code>number</code></li><li><strong>Default:</strong> <code>0</code> (or <code>10</code> if <code>print</code>, <code>failOnDanger</code>, or UI is enabled)</li></ul><p>Maximum number of imports to collect and display in CLI output, <a href="/guide/ui.html#import-breakdown">Vitest UI</a>, and third-party reporters.</p><h3 id="experimental-importdurationsthresholds" tabindex="-1">experimental.importDurations.thresholds <a class="header-anchor" href="#experimental-importdurationsthresholds" aria-label="Permalink to “experimental.importDurations.thresholds”">​</a></h3><ul><li><strong>Type:</strong> <code>{ warn?: number; danger?: number }</code></li><li><strong>Default:</strong> <code>{ warn: 100, danger: 500 }</code></li></ul><p>Duration thresholds in milliseconds for coloring and warnings:</p><ul><li><code>warn</code>: Threshold for yellow/warning color (default: 100ms)</li><li><code>danger</code>: Threshold for red/danger color and <code>failOnDanger</code> (default: 500ms)</li></ul><div class="info custom-block"><p class="custom-block-title custom-block-title-default">INFO</p><p><a href="/guide/ui.html#import-breakdown">Vitest UI</a> 会在至少一个文件的加载时间超过 <code>danger</code> 阈值时，自动显示导入耗时分析。</p></div>',27)),a("h2",m,[s[17]||(s[17]=i("experimental.viteModuleRunner ",-1)),n(e,{type:"experimental"},{default:t(()=>[...s[16]||(s[16]=[i("4.1.0",-1)])]),_:1}),s[18]||(s[18]=i()),s[19]||(s[19]=a("a",{class:"header-anchor",href:"#experimental-vitemodulerunner","aria-label":"Permalink to “experimental.viteModuleRunner 4.1.0”"},"​",-1))]),s[29]||(s[29]=l(`<ul><li><strong>Type:</strong> <code>boolean</code></li><li><strong>Default:</strong> <code>true</code></li></ul><p>Controls whether Vitest uses Vite&#39;s <a href="https://vite.dev/guide/api-environment-runtimes#modulerunner" target="_blank" rel="noreferrer">module runner</a> to run the code or fallback to the native <code>import</code>.</p><p>If this option is defined in the root config, all <a href="/guide/projects.html">projects</a> will inherit it automatically.</p><p>Consider disabling the module runner if you are running tests in the same environment as your code (server backend or simple scripts, for example). However, we still recommend running <code>jsdom</code>/<code>happy-dom</code> tests with Vite&#39;s module runner or in <a href="/guide/browser/">the browser</a> since it doesn&#39;t require any additional configuration.</p><p>Disabling this flag will disable <em>all</em> file transforms:</p><ul><li>test files and your source code are not processed by Vite</li><li>your global setup files are not processed</li><li>your custom runner/pool/environment files are not processed</li><li>your config file is still processed by Vite (this happens before Vitest knows the <code>viteModuleRunner</code> flag)</li></ul><div class="warning custom-block"><p class="custom-block-title custom-block-title-default">WARNING</p><p>At the moment, Vitest still requires Vite for certain functionality like the module graph or watch mode.</p><p>Also note that this option only works with <code>forks</code> or <code>threads</code> <a href="/config/pool.html">pools</a>.</p></div><h3 id="module-runner" tabindex="-1">Module Runner <a class="header-anchor" href="#module-runner" aria-label="Permalink to “Module Runner”">​</a></h3><p>By default, Vitest runs tests in a very permissive module runner sandbox powered by Vite&#39;s <a href="https://vite.dev/guide/api-environment.html#environment-api" target="_blank" rel="noreferrer">Environment API</a>. Every file is categorized as either an &quot;inline&quot; module or an &quot;external&quot; module.</p><p>Module runner runs all &quot;inlined&quot; modules. It provides <code>import.meta.env</code>, <code>require</code>, <code>__dirname</code>, <code>__filename</code>, static <code>import</code>, and has its own module resolution mechanism. This makes it very easy to run code when you don&#39;t want to configure the environment and just need to test that the bare JavaScript logic you wrote works as intended.</p><p>All &quot;external&quot; modules run in native mode, meaning they are executed outside of the module runner sandbox. If you are running tests in Node.js, these files are imported with the native <code>import</code> keyword and processed by Node.js directly.</p><p>While running JSDOM/happy-dom tests in a permissive fake environment might be justified, running Node.js tests in a non-Node.js environment can hide and silence potential errors you may encounter in production, especially if your code doesn&#39;t require any additional transformations provided by Vite plugins.</p><h3 id="known-limitations" tabindex="-1">Known Limitations <a class="header-anchor" href="#known-limitations" aria-label="Permalink to “Known Limitations”">​</a></h3><p>Some Vitest features rely on files being transformed. Vitest uses synchronous <a href="https://nodejs.org/api/module.html#customization-hooks" target="_blank" rel="noreferrer">Node.js Loaders API</a> to transform test files and setup files to support these features:</p><ul><li><a href="/guide/in-source.html"><code>import.meta.vitest</code></a></li><li><a href="/api/vi.html#vi-mock"><code>vi.mock</code></a></li><li><a href="/api/vi.html#vi-hoisted"><code>vi.hoisted</code></a></li></ul><div class="warning custom-block"><p class="custom-block-title custom-block-title-default">WARNING</p><p>This means that Vitest requires at least Node 22.15 for those features to work. At the moment, they also do not work in Deno or Bun.</p><p>Vitest will only detect <code>vi.mock</code> and <code>vi.hoisted</code> inside of test files, they will not be hoisted inside imported modules.</p></div><p>This could affect performance because Vitest needs to read the file and process it. If you do not use these features, you can disable the transforms by setting <code>experimental.nodeLoader</code> to <code>false</code>. Vitest only reads test files and setup files while looking for <code>vi.mock</code> or <code>vi.hoisted</code>. Using these in other files won&#39;t hoist them to the top of the file and can lead to unexpected behavior.</p><p>Some features will not work due to the nature of <code>viteModuleRunner</code>, including:</p><ul><li>no <code>import.meta.env</code>: <code>import.meta.env</code> is a Vite feature, use <code>process.env</code> instead</li><li>no <code>plugins</code>: plugins are not applied because there is no transformation phase, use <a href="https://nodejs.org/api/module.html#customization-hooks" target="_blank" rel="noreferrer">customization hooks</a> via <a href="/config/execargv.html"><code>execArgv</code></a> instead</li><li>no <code>alias</code>: aliases are not applied because there is no transformation phase</li><li><code>istanbul</code> coverage provider doesn&#39;t work because there is no transformation phase, use <code>v8</code> instead</li></ul><div class="warning custom-block"><p class="custom-block-title">Coverage Support</p><p>At the momemnt Vitest supports coverage via <code>v8</code> provider as long as files can be transformed into JavaScript. To transform TypeScript, Vitest uses <a href="https://nodejs.org/api/module.html#modulestriptypescripttypescode-options" target="_blank" rel="noreferrer"><code>module.stripTypeScriptTypes</code></a> which is available in Node.js since v22.13. If you are using a custom <a href="https://nodejs.org/api/module.html#customization-hooks" target="_blank" rel="noreferrer">module loader</a>, Vitest is not able to reuse it to transform files for analysis.</p></div><p>With regards to mocking, it is also important to point out that ES modules do not support property override. This means that code like this won&#39;t work anymore:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;node:fs&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { vi } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vitest&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vi.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">spyOn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fs, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;readFileSync&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mockImplementation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;42&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ❌</span></span></code></pre></div><p>However, Vitest supports auto-spying on modules without overriding their implementation. When <code>vi.mock</code> is called with a <code>spy: true</code> argument, the module is mocked in a way that preserves original implementations, but all exported functions are wrapped in a <code>vi.fn()</code> spy:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;node:fs&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { vi } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vitest&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vi.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { spy: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fs.readFileSync.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mockImplementation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;42&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ✅</span></span></code></pre></div><p>Factory mocking is implemented using a top-level await. This means that mocked modules cannot be loaded with <code>require()</code> in your source code:</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vi.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">importOriginal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ...await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> importOriginal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    readFileSync: vi.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;node:fs&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// throws an error</span></span></code></pre></div><p>This limitation exists because factories can be asynchronous. This should not be a problem because Vitest doesn&#39;t mock builtin modules inside <code>node_modules</code>, which is simillar to how Vitest works by default.</p><h3 id="typescript" tabindex="-1">TypeScript <a class="header-anchor" href="#typescript" aria-label="Permalink to “TypeScript”">​</a></h3><p>If you are using Node.js 22.18/23.6 or higher, TypeScript will be <a href="https://nodejs.org/en/learn/typescript/run-natively" target="_blank" rel="noreferrer">transformed natively</a> by Node.js.</p><div class="warning custom-block"><p class="custom-block-title">TypeScript with Node.js 22.6-22.18</p><p>If you are using Node.js version between 22.6 and 22.18, you can also enable native TypeScript support via <code>--experimental-strip-types</code> flag:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NODE_OPTIONS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--experimental-strip-types&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> vitest</span></span></code></pre></div><p>If you are using TypeScript and Node.js version lower than 22.6, then you will need to either:</p><ul><li>build your test files and source code and run those files directly</li><li>import a <a href="https://nodejs.org/api/module.html#customization-hooks" target="_blank" rel="noreferrer">custom loader</a> via <code>execArgv</code> flag</li></ul><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vitest/config&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tsxApi</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;tsx/esm/api&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  test: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    execArgv: [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      \`--import=data:text/javascript,import * as tsx from &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tsxApi</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}&quot;;tsx.register()\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    experimental: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      viteModuleRunner: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><p>If you are running tests in Deno, TypeScript files are processed by the runtime without any additional configurations.</p></div>`,30)),a("h2",f,[s[21]||(s[21]=i("experimental.nodeLoader ",-1)),n(e,{type:"experimental"},{default:t(()=>[...s[20]||(s[20]=[i("4.1.0",-1)])]),_:1}),s[22]||(s[22]=i()),s[23]||(s[23]=a("a",{class:"header-anchor",href:"#experimental-nodeloader","aria-label":"Permalink to “experimental.nodeLoader 4.1.0”"},"​",-1))]),s[30]||(s[30]=l('<ul><li><strong>Type:</strong> <code>boolean</code></li><li><strong>Default:</strong> <code>true</code></li></ul><p>If module runner is disabled, Vitest uses a native <a href="https://nodejs.org/api/module.html#customization-hooks" target="_blank" rel="noreferrer">Node.js module loader</a> to transform files to support <code>import.meta.vitest</code>, <code>vi.mock</code> and <code>vi.hoisted</code>.</p><p>If you don&#39;t use these features, you can disable this to improve performance.</p>',3))])}const B=p(c,[["render",F]]);export{w as __pageData,B as default};
