import{_ as i,o as a,i as e,R as n}from"./chunks/framework.XDTXXE-5.js";const c=JSON.parse('{"title":"常见错误 | 指南","description":"","frontmatter":{"title":"常见错误 | 指南"},"headers":[],"relativePath":"guide/common-errors.md","filePath":"guide/common-errors.md","lastUpdated":1771601921000}'),t={name:"guide/common-errors.md"};function l(h,s,o,p,r,k){return a(),e("div",null,[...s[0]||(s[0]=[n(`<h1 id="common-errors" tabindex="-1">常见错误 <a class="header-anchor" href="#common-errors" aria-label="Permalink to “常见错误”">​</a></h1><h2 id="cannot-find-module-relative-path" tabindex="-1">Cannot find module &#39;./relative-path&#39; <a class="header-anchor" href="#cannot-find-module-relative-path" aria-label="Permalink to “Cannot find module &#39;./relative-path&#39;”">​</a></h2><p>如果你收到一个 <strong>module cannot be found</strong> 的报错，则可能意味着几种不同情况：</p><ol><li>你拼错了路径。确保路径正确。</li><li>你可能依赖于 <code>tsconfig.json</code> 中的 <code>baseUrl</code>。默认情况下，Vite 不考虑 <code>tsconfig.json</code>，因此如果你依赖此行为，你可能需要自己安装 <a href="https://www.npmjs.com/package/vite-tsconfig-paths" target="_blank" rel="noreferrer"><code>vite-tsconfig-paths</code></a>。</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tsconfigPaths </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vite-tsconfig-paths&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vitest/config&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  plugins: [</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tsconfigPaths</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><p>或者重写你的路径，使它不是相对于 root。</p><div class="language-diff"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#B31D28;--shiki-dark:#FDAEB7;">- import helpers from &#39;src/helpers&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">+ import helpers from &#39;../src/helpers&#39;</span></span></code></pre></div><ol start="3"><li>确保你没有使用相对路径的 <a href="/config/alias.html">别名</a>。Vite 将它们视为相对于导入所在的文件而不是根目录。</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark has-diff" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vitest/config&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  test: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    alias: {</span></span>
<span class="line diff remove"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;@/&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./src/&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line diff add"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &#39;@/&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;./src/&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">meta</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.url).pathname, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><h2 id="failed-to-terminate-worker" tabindex="-1">Failed to Terminate Worker <a class="header-anchor" href="#failed-to-terminate-worker" aria-label="Permalink to “Failed to Terminate Worker”">​</a></h2><p>This error can happen when NodeJS&#39;s <code>fetch</code> is used with <a href="/config/pool.html#threads"><code>pool: &#39;threads&#39;</code></a>. See <a href="https://github.com/vitest-dev/vitest/issues/3077" target="_blank" rel="noreferrer">#3077</a> for details.</p><p>The default <a href="/config/pool.html#forks"><code>pool: &#39;forks&#39;</code></a> does not have this issue. If you&#39;ve explicitly set <code>pool: &#39;threads&#39;</code>, switching back to <code>&#39;forks&#39;</code> or using <a href="/config/pool.html#vmforks"><code>&#39;vmForks&#39;</code></a> will resolve it.</p><h2 id="custom-package-conditions-are-not-resolved" tabindex="-1">Custom package conditions are not resolved <a class="header-anchor" href="#custom-package-conditions-are-not-resolved" aria-label="Permalink to “Custom package conditions are not resolved”">​</a></h2><p>If you are using custom conditions in your <code>package.json</code> <a href="https://nodejs.org/api/packages.html#package-entry-points" target="_blank" rel="noreferrer">exports</a> or <a href="https://nodejs.org/api/packages.html#subpath-imports" target="_blank" rel="noreferrer">subpath imports</a>, you may find that Vitest does not respect these conditions by default.</p><p>For example, if you have the following in your <code>package.json</code>:</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;exports&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./lib/custom.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;import&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./lib/index.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;imports&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;#internal&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;custom&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./src/internal.js&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;./lib/internal.js&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>By default, Vitest will only use the <code>import</code> and <code>default</code> conditions. To make Vitest respect custom conditions, you need to configure <a href="https://vite.dev/config/ssr-options#ssr-resolve-conditions" target="_blank" rel="noreferrer"><code>ssr.resolve.conditions</code></a> in your Vitest config:</p><div class="vp-code-block-title"><div class="vp-code-block-title-bar"><span class="vp-code-block-title-text" data-title="vitest.config.js">vitest.config.js</span></div><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vitest/config&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ssr: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    resolve: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      conditions: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;custom&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;import&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;default&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div></div><div class="tip custom-block"><p class="custom-block-title">Why <code>ssr.resolve.conditions</code> and not <code>resolve.conditions</code>?</p><p>Vitest follows Vite&#39;s configuration convention:</p><ul><li><a href="https://vite.dev/config/shared-options#resolve-conditions" target="_blank" rel="noreferrer"><code>resolve.conditions</code></a> applies to Vite&#39;s <code>client</code> environment, which corresponds to Vitest&#39;s browser mode, jsdom, happy-dom, or custom environments with <code>viteEnvironment: &#39;client&#39;</code>.</li><li><a href="https://vite.dev/config/ssr-options#ssr-resolve-conditions" target="_blank" rel="noreferrer"><code>ssr.resolve.conditions</code></a> applies to Vite&#39;s <code>ssr</code> environment, which corresponds to Vitest&#39;s node environment or custom environments with <code>viteEnvironment: &#39;ssr&#39;</code>.</li></ul><p>Since Vitest defaults to the <code>node</code> environment (which uses <code>viteEnvironment: &#39;ssr&#39;</code>), module resolution uses <code>ssr.resolve.conditions</code>. This applies to both package exports and subpath imports.</p><p>You can learn more about Vite environments and Vitest environments in <a href="/config/environment.html"><code>environment</code></a>.</p></div><h2 id="segfaults-and-native-code-errors" tabindex="-1">Segfaults and Native Code Errors <a class="header-anchor" href="#segfaults-and-native-code-errors" aria-label="Permalink to “Segfaults and Native Code Errors”">​</a></h2><p>运行 <a href="https://nodejs.org/api/addons.html" target="_blank" rel="noreferrer">原生 NodeJS 模块</a> 在 <code>pool: &#39;threads&#39;</code> 中，可能会遇到来自原生代码的神秘错误。</p><ul><li><code>Segmentation fault (core dumped)</code></li><li><code>thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;assertion failed</code></li><li><code>Abort trap: 6</code></li><li><code>internal error: entered unreachable code</code></li></ul><p>在这些情况下，原生模块可能不是为多线程安全而构建的。在解决方案中，你可以切换到 <code>pool: &#39;forks&#39;</code>，它在多个 <code>node:child_process</code> 而不是多个 <code>node:worker_threads</code> 中运行测试用例。</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-112" id="tab-113" checked><label data-title="vitest.config.js" for="tab-113">vitest.config.js</label><input type="radio" name="group-112" id="tab-114"><label data-title="CLI" for="tab-114">CLI</label></div><div class="blocks"><div class="language-ts active"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { defineConfig } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;vitest/config&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  test: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    pool: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;forks&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vitest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --pool=forks</span></span></code></pre></div></div></div>`,24)])])}const g=i(t,[["render",l]]);export{c as __pageData,g as default};
